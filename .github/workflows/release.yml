name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Get version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Get Git commit info
      id: git_info
      run: |
        echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

    - name: Build binary with version info
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ steps.get_version.outputs.VERSION }}
        COMMIT: ${{ steps.git_info.outputs.COMMIT }}
        BUILD_DATE: ${{ steps.git_info.outputs.DATE }}
      run: |
        # Set binary name
        BINARY_NAME="todo"
        if [ "${{ matrix.goos }}" = "windows" ]; then
          BINARY_NAME="todo.exe"
        fi

        # Set output name
        OUTPUT_NAME="todo-${{ matrix.goos }}-${{ matrix.goarch }}-${BINARY_NAME}"

        # Build with version information
        go build -v \
          -ldflags="-s -w -X github.com/SongRunqi/go-todo/internal/version.Version=${VERSION} -X github.com/SongRunqi/go-todo/internal/version.GitCommit=${COMMIT} -X github.com/SongRunqi/go-todo/internal/version.BuildDate=${BUILD_DATE}" \
          -o ${OUTPUT_NAME} \
          ./main.go

        # Show file info
        ls -lh ${OUTPUT_NAME}

        # Generate SHA256 checksum
        if [ "${{ matrix.goos }}" = "darwin" ]; then
          shasum -a 256 ${OUTPUT_NAME} | cut -d ' ' -f 1 > ${OUTPUT_NAME}.sha256
        else
          sha256sum ${OUTPUT_NAME} | cut -d ' ' -f 1 > ${OUTPUT_NAME}.sha256
        fi

        cat ${OUTPUT_NAME}.sha256

    - name: Upload binaries to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          todo-${{ matrix.goos }}-${{ matrix.goarch }}-*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
